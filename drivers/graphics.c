// SPDX-License-Identifier: GPL-2.0-only
/*
 * drivers/graphics.c
 *
 * Advanced framebuffer driver, for complex graphics operations.
 *
 * Copyright (C) 2024 Goldside543
 *
 */

#include <stdint.h>
#include "../kernel/print.h"
#include "../kernel/abs.h"

#define FRAMEBUFFER_ADDR 0xA0000
#define SCREEN_WIDTH  80
#define SCREEN_HEIGHT 25

void init_graphics() {
    print("Loading advanced framebuffer driver...\n");
    uint8_t *framebuffer = (uint8_t *)FRAMEBUFFER_ADDR;
    print("Advanced framebuffer driver loaded.");
    for (int y = 0; y < SCREEN_HEIGHT; ++y) {
        for (int x = 0; x < SCREEN_WIDTH; ++x) {
            framebuffer[y * SCREEN_WIDTH + x] = (0x0F << 8) | ' ';
        }
    }
}

// Helper function to set a pixel
static void set_pixel(int x, int y, uint8_t color) {
    if (x >= 0 && x < SCREEN_WIDTH && y >= 0 && y < SCREEN_HEIGHT) {
        uint8_t *framebuffer = (uint8_t *)FRAMEBUFFER_ADDR;
        framebuffer[y * SCREEN_WIDTH + x] = color;
    }
}


// Draw a rectangle
void draw_rectangle(int x, int y, int width, int height, uint8_t color) {
    for (int i = y; i < y + height; ++i) {
        for (int j = x; j < x + width; ++j) {
            set_pixel(j, i, color);
        }
    }
}

// Draw a line (Bresenham's line algorithm)
void draw_line(int x1, int y1, int x2, int y2, uint8_t color) {
    int dx = abs(x2 - x1);
    int dy = abs(y2 - y1);
    int sx = x1 < x2 ? 1 : -1;
    int sy = y1 < y2 ? 1 : -1;
    int err = dx - dy;

    while (1) {
        set_pixel(x1, y1, color);
        if (x1 == x2 && y1 == y2) break;
        int e2 = err * 2;
        if (e2 > -dy) { err -= dy; x1 += sx; }
        if (e2 < dx) { err += dx; y1 += sy; }
    }
}

static const uint8_t font[128][8] = {
    // Space
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // ! (exclamation mark)
    {0x00, 0x00, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00},
    // " (double quote)
    {0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // # (hash)
    {0x14, 0x3F, 0x14, 0x3F, 0x14, 0x00, 0x00, 0x00},
    // $ (dollar sign)
    {0x12, 0x1F, 0x12, 0x1F, 0x02, 0x00, 0x00, 0x00},
    // % (percent)
    {0x13, 0x19, 0x0E, 0x07, 0x16, 0x00, 0x00, 0x00},
    // & (ampersand)
    {0x0E, 0x11, 0x15, 0x0A, 0x14, 0x00, 0x00, 0x00},
    // ' (single quote)
    {0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // ( (left parenthesis)
    {0x00, 0x0E, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00},
    // ) (right parenthesis)
    {0x00, 0x11, 0x11, 0x11, 0x0E, 0x00, 0x00, 0x00},
    // * (asterisk)
    {0x00, 0x15, 0x0E, 0x15, 0x00, 0x00, 0x00, 0x00},
    // + (plus)
    {0x00, 0x04, 0x0E, 0x04, 0x00, 0x00, 0x00, 0x00},
    // , (comma)
    {0x00, 0x00, 0x06, 0x03, 0x00, 0x00, 0x00, 0x00},
    // - (hyphen)
    {0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00},
    // . (period)
    {0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00},
    // / (slash)
    {0x00, 0x01, 0x03, 0x06, 0x0C, 0x18, 0x00, 0x00},
    // 0
    {0x0E, 0x11, 0x15, 0x15, 0x1A, 0x0E, 0x00, 0x00},
    // 1
    {0x00, 0x12, 0x1F, 0x10, 0x00, 0x00, 0x00, 0x00},
    // 2
    {0x12, 0x13, 0x15, 0x15, 0x09, 0x06, 0x00, 0x00},
    // 3
    {0x12, 0x13, 0x11, 0x15, 0x1A, 0x0E, 0x00, 0x00},
    // 4
    {0x04, 0x0C, 0x14, 0x1F, 0x04, 0x00, 0x00, 0x00},
    // 5
    {0x1F, 0x10, 0x1E, 0x01, 0x1E, 0x00, 0x00, 0x00},
    // 6
    {0x0E, 0x10, 0x1E, 0x15, 0x1E, 0x00, 0x00, 0x00},
    // 7
    {0x1F, 0x01, 0x03, 0x06, 0x0C, 0x00, 0x00, 0x00},
    // 8
    {0x0E, 0x15, 0x0E, 0x15, 0x0E, 0x00, 0x00, 0x00},
    // 9
    {0x0E, 0x15, 0x1F, 0x01, 0x0E, 0x00, 0x00, 0x00},
    // : (colon)
    {0x00, 0x00, 0x0A, 0x00, 0x00, 0x0A, 0x00, 0x00},
    // ; (semicolon)
    {0x00, 0x00, 0x06, 0x03, 0x00, 0x00, 0x00, 0x00},
    // < (less than)
    {0x00, 0x04, 0x0A, 0x11, 0x00, 0x00, 0x00, 0x00},
    // = (equals)
    {0x00, 0x0A, 0x0A, 0x0A, 0x00, 0x00, 0x00, 0x00},
    // > (greater than)
    {0x00, 0x11, 0x0A, 0x04, 0x00, 0x00, 0x00, 0x00},
    // ? (question mark)
    {0x00, 0x12, 0x13, 0x02, 0x00, 0x00, 0x00, 0x00},
    // @ (at)
    {0x0E, 0x15, 0x15, 0x1D, 0x02, 0x00, 0x00, 0x00},
    // A
    {0x1E, 0x11, 0x11, 0x1F, 0x11, 0x00, 0x00, 0x00},
    // B
    {0x1F, 0x15, 0x15, 0x1A, 0x00, 0x00, 0x00, 0x00},
    // C
    {0x0E, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00},
    // D
    {0x1F, 0x11, 0x11, 0x0E, 0x00, 0x00, 0x00, 0x00},
    // E
    {0x1F, 0x15, 0x15, 0x11, 0x00, 0x00, 0x00, 0x00},
    // F
    {0x1F, 0x14, 0x14, 0x10, 0x00, 0x00, 0x00, 0x00},
    // G
    {0x0E, 0x11, 0x15, 0x15, 0x0A, 0x00, 0x00, 0x00},
    // H
    {0x1F, 0x04, 0x04, 0x1F, 0x00, 0x00, 0x00, 0x00},
    // I
    {0x11, 0x1F, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00},
    // J
    {0x01, 0x11, 0x1F, 0x10, 0x00, 0x00, 0x00, 0x00},
    // K
    {0x1F, 0x04, 0x0A, 0x11, 0x00, 0x00, 0x00, 0x00},
    // L
    {0x1F, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00},
    // M
    {0x1F, 0x08, 0x04, 0x08, 0x1F, 0x00, 0x00, 0x00},
    // N
    {0x1F, 0x08, 0x04, 0x03, 0x00, 0x00, 0x00, 0x00},
    // O
    {0x0E, 0x11, 0x11, 0x0E, 0x00, 0x00, 0x00, 0x00},
    // P
    {0x1F, 0x14, 0x14, 0x08, 0x00, 0x00, 0x00, 0x00},
    // Q
    {0x0E, 0x11, 0x15, 0x0F, 0x01, 0x00, 0x00, 0x00},
    // R
    {0x1F, 0x14, 0x14, 0x0B, 0x00, 0x00, 0x00, 0x00},
    // S
    {0x0E, 0x15, 0x15, 0x12, 0x00, 0x00, 0x00, 0x00},
    // T
    {0x10, 0x1F, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00},
    // U
    {0x1E, 0x10, 0x10, 0x1E, 0x00, 0x00, 0x00, 0x00},
    // V
    {0x1C, 0x10, 0x08, 0x1C, 0x00, 0x00, 0x00, 0x00},
    // W
    {0x1F, 0x10, 0x0E, 0x10, 0x1F, 0x00, 0x00, 0x00},
    // X
    {0x11, 0x0A, 0x04, 0x0A, 0x11, 0x00, 0x00, 0x00},
    // Y
    {0x11, 0x0A, 0x04, 0x1F, 0x00, 0x00, 0x00, 0x00},
    // Z
    {0x11, 0x13, 0x15, 0x19, 0x00, 0x00, 0x00, 0x00},
    // [ (left bracket)
    {0x0E, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00},
    // \ (backslash)
    {0x18, 0x0C, 0x06, 0x03, 0x01, 0x00, 0x00, 0x00},
    // ] (right bracket)
    {0x11, 0x11, 0x11, 0x11, 0x0E, 0x00, 0x00, 0x00},
    // ^ (caret)
    {0x04, 0x02, 0x01, 0x02, 0x04, 0x00, 0x00, 0x00},
    // _ (underscore)
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00},
    // ` (grave accent)
    {0x00, 0x03, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00},
    // a
    {0x00, 0x0E, 0x15, 0x15, 0x1A, 0x00, 0x00, 0x00},
    // b
    {0x1F, 0x11, 0x11, 0x0E, 0x00, 0x00, 0x00, 0x00},
    // c
    {0x00, 0x0E, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00},
    // d
    {0x00, 0x11, 0x11, 0x0F, 0x00, 0x00, 0x00, 0x00},
    // e
    {0x00, 0x0E, 0x15, 0x15, 0x0A, 0x00, 0x00, 0x00},
    // f
    {0x00, 0x1F, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00},
    // g
    {0x00, 0x0E, 0x15, 0x15, 0x1F, 0x00, 0x00, 0x00},
    // h
    {0x1F, 0x04, 0x04, 0x1F, 0x00, 0x00, 0x00, 0x00},
    // i
    {0x00, 0x11, 0x1F, 0x10, 0x00, 0x00, 0x00, 0x00},
    // j
    {0x00, 0x01, 0x11, 0x1F, 0x10, 0x00, 0x00, 0x00},
    // k
    {0x1F, 0x04, 0x0A, 0x11, 0x00, 0x00, 0x00, 0x00},
    // l
    {0x00, 0x11, 0x1F, 0x01, 0x00, 0x00, 0x00, 0x00},
    // m
    {0x00, 0x1F, 0x08, 0x04, 0x08, 0x1F, 0x00, 0x00},
    // n
    {0x00, 0x1F, 0x08, 0x04, 0x00, 0x00, 0x00, 0x00},
    // o
    {0x00, 0x0E, 0x11, 0x11, 0x0E, 0x00, 0x00, 0x00},
    // p
    {0x00, 0x1F, 0x14, 0x14, 0x08, 0x00, 0x00, 0x00},
    // q
    {0x00, 0x0E, 0x11, 0x15, 0x1E, 0x00, 0x00, 0x00},
    // r
    {0x00, 0x1F, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00},
    // s
    {0x00, 0x0E, 0x15, 0x15, 0x0A, 0x00, 0x00, 0x00},
    // t
    {0x00, 0x04, 0x1F, 0x04, 0x00, 0x00, 0x00, 0x00},
    // u
    {0x00, 0x1E, 0x10, 0x10, 0x1E, 0x00, 0x00, 0x00},
    // v
    {0x00, 0x1C, 0x10, 0x08, 0x1C, 0x00, 0x00, 0x00},
    // w
    {0x00, 0x1F, 0x10, 0x0E, 0x10, 0x1F, 0x00, 0x00},
    // x
    {0x00, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x00, 0x00},
    // y
    {0x00, 0x11, 0x0A, 0x04, 0x1F, 0x00, 0x00, 0x00},
    // z
    {0x00, 0x11, 0x13, 0x15, 0x19, 0x00, 0x00, 0x00},
    // { (left brace)
    {0x04, 0x0A, 0x11, 0x0A, 0x04, 0x00, 0x00, 0x00},
    // | (vertical bar)
    {0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x00, 0x00, 0x00},
    // } (right brace)
    {0x11, 0x0A, 0x04, 0x0A, 0x11, 0x00, 0x00, 0x00},
    // ~ (tilde)
    {0x06, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
};

// Draw a character at (x, y)
void draw_char(int x, int y, char ch, uint8_t color) {
    if (ch < 32 || ch > 127) return; // Handle out-of-bounds characters
    const uint8_t *bitmap = font[ch - 32];
    for (int i = 0; i < 8; ++i) {
        for (int j = 0; j < 8; ++j) {
            if (bitmap[i] & (1 << (7 - j))) {
                set_pixel(x + j, y + i, color);
            }
        }
    }
}


// Draw a string at (x, y)
void draw_text(int x, int y, const char *text, uint8_t color) {
    while (*text) {
        draw_char(x, y, *text++, color);
        x += 8; // Move to the next character position
    }
}
